@page "/c_pelicula"
@inject HttpClient httpClient

<div class="card">
	<div class="card-header">
		<h3 class="card align-items-center">Movies</h3>
	</div>
	<style>
		.red-card {
			background-color: #ff0000;
			color: #ffffff;
		}
	</style>
	<div class="card-body">
		<form>
			<div class="input-group mb-3">
				<input type="text" @bind="FiltroTitulo" class="form-control" placeholder="Buscar por título" />
				<input type="date" @bind="FechaInicio" class="form-control">
				<input type="date" @bind="FechaFin" class="form-control" />
				<button @onclick="Buscar" class="btn btn-outline-primary" type="button" id="buscarButton">
					<i class="oi oi-magnifying-glass" />
				</button>
				<button @onclick="VaciarCampos" class="btn btn-outline-secondary" type="button">
					<i class="oi oi-trash" /> Limpiar
				</button>
			</div>
		</form>

		@if (Pelicula is not null)
		{
			<div class="row">
				@foreach (var pelicula in Pelicula)
				{
					<div class="col-md-4 mb-4">
						<div class="card red-card">
							<div class="card-body text-center">
								@if (pelicula.Imagen != null)
								{
									var base64 = Convert.ToBase64String(pelicula.Imagen);
									var imgSrc = $"data:image/jpeg;base64,{base64}";
									<img src="@imgSrc" alt="Imagen de la película" class="img-fluid" />
								}
							</div>
						</div>
						<div class="align-content-center">
							<div class="text-center">
								<a href="detallepelicula/@pelicula.PeliculaId" class="card-title">@pelicula.Titulo</a>
							</div>
						</div>
					</div>
				}
			</div>
		}
	</div>

	<div class="card-footer">
		<div class="form-row justify-content-sm-between" aria-orientation="vertical">
			<div class="col-3">
				<label for="CantidaRegistro" class="col-form-label"><strong>Post</strong>&nbsp;</label>
				<input id="CantidaRegistro" @bind-value="@conteo" disabled class="form-control" />
			</div>
		</div>
	</div>
</div>

@code {
	public string? FiltroTitulo { get; set; }
	public DateTime? FiltroFecha { get; set; }

	public List<Peliculas>? Pelicula { get; set; }
	public int conteo { get; set; }
	public DateTime? FechaInicio { get; set; }
	public DateTime? FechaFin { get; set; }

	protected override async Task OnInitializedAsync()
	{
		await Buscar();
	}

	public void VaciarCampos()
	{
		FiltroTitulo = "";
		FechaInicio = DateTime.MinValue;
		FechaFin = DateTime.MinValue;
	}

	public async Task Buscar()
	{
		Pelicula = await httpClient.GetFromJsonAsync<List<Peliculas>>($"api/Peliculas");

		if (!string.IsNullOrEmpty(FiltroTitulo))
		{
			Pelicula = Pelicula
				.Where(p => string.IsNullOrWhiteSpace(FiltroTitulo) || p.Titulo.IndexOf(FiltroTitulo, StringComparison.OrdinalIgnoreCase) >= 0)
				.ToList();
		}
		else if (FiltroFecha != null)
		{
			Pelicula = Pelicula.Where(p => p.FechaEstreno.Date == FiltroFecha.Value.Date).ToList();
		}
		else if (FechaInicio != null && FechaFin != null)
		{
			Pelicula = Pelicula
				.Where(p => p.FechaEstreno.Date >= FechaInicio.Value.Date && p.FechaEstreno.Date <= FechaFin.Value.Date)
				.ToList();
		}

		conteo = Pelicula != null ? Pelicula!.Count() : 0;
		StateHasChanged();
	}
}
